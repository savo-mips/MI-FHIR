<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>MommyNotes | Dashboard</title>
    <link rel="stylesheet" href="stylesheet.css">
</head>

<body onload="loadObservations()">
    <div class="container">
    <div class="box" id="box1"></div>
    <div class="box" id="box2"></div>
    <div class="box" id="box3"></div>
    <div class="box" id="box4"></div>
    <div class="box" id="box5"></div>
    <div class="box" id="box6"></div>
  </div>

  <div id="result"></div>
</body>
<script>
    // log in check!!
    document.addEventListener("DOMContentLoaded", function () {
    const sessionToken = localStorage.getItem("sessionToken");

    if (!sessionToken) {
      alert("You are not logged in. You will be sent back to the log-in page");
      window.location.href = "login.html";
    } else {
      console.log("login token:", sessionToken);
    }
    });
    // login check ends here

   
    const fhir = 'https://hapi.fhir.org/baseR5';
    const patientId = '799933';

    // LOINC-codes you want to find, add them here
    const codesToFind = [
        '8867-4',
        '2339-0',
        '29463-7',
        '11884-4'
    ];

    async function loadObservations() {
        const resultDiv = document.getElementById('result');
        
        resultDiv.innerHTML = 'Loading...';

        try {
            const response = await fetch(`${fhir}/Observation?patient=${patientId}`);
            const data = await response.json();

            if (!data.entry || data.entry.length === 0) {
                resultDiv.textContent = 'No observations found.';
                return;
            }

            let output = '';
            i = 1
            for (const code of codesToFind) {
                
                const currentBoxDiv = document.getElementById(`box${i}`);
                const obs = data.entry.find(entry =>
                    entry.resource.code?.coding?.some(c => c.code === code)
                );

                if (obs) {
                    const resource = obs.resource;
                    const value = resource.valueQuantity?.value;
                    const unit = resource.valueQuantity?.unit;
                    const label = resource.code.coding[0].display
                    output = `${label}:<br> 
                    ${value} ${unit}`;
                    currentBoxDiv.innerHTML = output
                } else {
                    output += `Observation for code ${code} not found.<br>`;
                }
                i++
            }
            resultDiv.innerHTML = '';

        } catch (err) {
            console.error(err);
            resultDiv.innerHTML = 'Error fetching data.';
        }
    }

</script>
</html>